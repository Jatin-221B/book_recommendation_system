<h1><%= @book.title %></h1>

<%# link_to 'Back to Books', books_path %>

<div class="book-details">
  <p><strong>Author:</strong> <%= link_to @book.author.name, author_path(@book.author) %></p>
  <p><strong>Genre:</strong> <%= @book.genre %></p>
  
  <% if @average_rating %>
    <p><strong>Average Rating:</strong> ★ <%= @average_rating %>/5</p>
  <% end %>
  
  <div class="book-description">
    <h3>Description</h3>
    <p><%= @book.description %></p>
  </div>
</div>

<hr>

<!-- Favourites Section -->
<div class="favourite-section">
  <% if current_user %>
    <% existing_favourite = current_user.favourites.find_by(book_id: @book.id) %>
    
    <% if existing_favourite %>
      <%= button_to "Remove from Favourites", favourite_path(existing_favourite), method: :delete, class: "btn-favourite active" %>
    <% else %>
      <%= button_to " Add to Favourites", favourites_path, method: :post, params: { favourite: { book_id: @book.id } }, class: "btn-favourite" %>
    <% end %>
  <% else %>
    <p><em>Login to add this book to your favourites</em></p>
  <% end %>
</div>

<hr>

<!-- New Review Form -->
<div class="new-review">
  <h3>Write a Review</h3>
  
  <% if current_user %>
    <%= form_with model: @review || Review.new, url: reviews_path, local: true do |f| %>
      <%= f.hidden_field :book_id, value: @book.id %>
      
      <div class="field">
        <%= f.label :rating, "Rating:" %>
        <%= f.select :rating, options_for_select([[1,1], [2,2], [3,3], [4,4], [5,5]], @review&.rating), { prompt: "Select rating" } %>
      </div>
      
      <div class="field">
        <%= f.label :content, "Review:" %>
        <%= f.text_area :content, rows: 5, placeholder: "Write your review here..." %>
      </div>
      
      <!-- Show errors if any -->
      <% if @review&.errors&.any? %>
        <div class="errors">
          <h4><%= pluralize(@review.errors.count, "error") %> prevented this review from being saved:</h4>
          <ul>
            <% @review.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <div class="actions">
        <%= f.submit "Submit Review", class: "btn-primary" %>
      </div>
    <% end %>
  <% else %>
    <p><em>Login to write a review</em></p>
  <% end %>
</div>

<hr>

<!-- Reviews Section -->
<div class="book-reviews">
  <h2>Reviews (<%= @reviews.count %>)</h2>
  
  <% if @reviews.any? %>
    <% @reviews.each do |review| %>
      <div class="review">
        <h4><%= link_to review.user.name, user_path(review.user) %></h4>
        <p><strong>Rating:</strong> <%= '★' * review.rating.to_i %> (<%= review.rating %>/5)</p>
        <p><%= review.content %></p>
        
        <% if review.created_at == review.updated_at %>
          <p><small><i>Created <%= review.created_at.strftime('%B %d, %Y at %I:%M %p') %></i></small></p>
        <% else %>
          <p><small><i>Updated <%= review.updated_at.strftime('%B %d, %Y at %I:%M %p') %></i></small></p>
        <% end %>
        
        <!-- Edit/Delete buttons (only for review owner) -->
        <% if current_user && review.user == current_user %>
          <div class="review-actions">
            <%= link_to "Edit", edit_review_path(review), class: "btn-edit" %> |
            <%= button_to "Delete", review_path(review), method: :delete, data: { confirm: "Are you sure you want to delete this review?" }, class: "btn-delete" %>
          </div>
        <% end %>
      </div>
      <hr>
    <% end %>
  <% else %>
    <p>No reviews yet. Be the first to review this book!</p>
  <% end %>
</div>