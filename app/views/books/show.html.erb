<div class="container py-5">

<% if @book.present? %>

  <!-- BOOK HEADER -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">

      <div class="d-flex justify-content-between flex-wrap">
        <div>
          <h1 class="fw-bold mb-2"><%= @book.title %></h1>

          <p class="text-muted mb-2">
            by <%= link_to @book.author.name,
                           author_path(@book.author),
                           class: "text-decoration-none" %>
          </p>

          <span class="badge bg-secondary mb-2">
            <%= @book.genre %>
          </span>

          <% if @average_rating %>
            <p class="mt-2 mb-0">
              <strong>Average Rating:</strong>
              <span class="text-warning">
                <%= '★' * @average_rating.round %>
              </span>
              (<%= @average_rating %>/5)
            </p>
          <% end %>
        </div>

        <div class="mt-3 mt-md-0">
          <%= link_to "Back to Books",
                      books_path,
                      class: "btn btn-outline-secondary btn-sm" %>
        </div>
      </div>

      <hr>

      <h5 class="fw-bold">Description</h5>
      <p class="text-muted mb-0">
        <%= @book.description %>
      </p>

    </div>
  </div>



  <!-- FAVOURITES SECTION -->
  <div class="mb-4">
    <% if current_user %>
      <% existing_favourite = current_user.favourites.find_by(book_id: @book.id) %>

      <% if existing_favourite %>
        <%= button_to "Remove from Favourites",
                      favourite_path(existing_favourite),
                      method: :delete,
                      class: "btn btn-danger" %>
      <% else %>
        <%= button_to "Add to Favourites",
                      favourites_path,
                      method: :post,
                      params: { favourite: { book_id: @book.id } },
                      class: "btn btn-outline-primary" %>
      <% end %>
    <% else %>
      <div class="alert alert-info">
        Login to add this book to your favourites.
      </div>
    <% end %>
  </div>



  <!-- REVIEW FORM -->
  <div class="card shadow-sm border-0 mb-5">
    <div class="card-body">

      <details>
        <summary class="btn btn-primary mb-3">Write a Review</summary>

        <% if current_user %>
          <%= form_with model: [@book, @review], local: true do |f| %>

            <%= f.hidden_field :book_id, value: @book.id %>

            <div class="mb-3">
              <%= f.label :rating, "Rating", class: "form-label" %>
              <%= f.select :rating,
                           options_for_select([[1,1],[2,2],[3,3],[4,4],[5,5]], @review&.rating),
                           { prompt: "Select rating" },
                           class: "form-select" %>
            </div>

            <div class="mb-3">
              <%= f.label :content, "Review", class: "form-label" %>
              <%= f.text_area :content,
                              rows: 5,
                              class: "form-control",
                              placeholder: "Write your review here..." %>
            </div>

            <% if @review&.errors&.any? %>
              <div class="alert alert-danger">
                <strong><%= pluralize(@review.errors.count, "error") %> prevented this review:</strong>
                <ul class="mb-0">
                  <% @review.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <%= f.submit "Submit Review",
                         class: "btn btn-success" %>

          <% end %>
        <% else %>
          <div class="alert alert-info">
            Login to write a review.
          </div>
        <% end %>

      </details>

    </div>
  </div>



  <!-- REVIEWS SECTION -->
<h3 class="fw-bold mb-4">
  Reviews (<%= @reviews.count %>)
</h3>

<% if @reviews.any? %>

  <% @vis_reviews = @reviews.order(updated_at: :desc).first(5) %>

  <% @vis_reviews.each do |review| %>

    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">

        <!-- REVIEW DISPLAY -->
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <%= link_to review.user.name,
                        user_path(review.user),
                        class: "text-decoration-none" %>
          </h5>

          <span class="text-warning">
            <%= '★' * review.rating.to_i %>
          </span>
        </div>

        <p class="mt-2 text-muted">
          <%= review.content %>
        </p>

        <p class="small text-muted">
          <%= review.updated_at.strftime('%B %d, %Y at %I:%M %p') %>
        </p>

        <% if current_user && review.user == current_user %>

          <!-- ACTION BUTTONS -->
          <div class="mt-3">

            <!-- EDIT TOGGLE -->
            <button class="btn btn-outline-primary btn-sm me-2"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#editReview<%= review.id %>">
              Edit
            </button>

            <!-- DELETE -->
            <%= button_to "Delete",
                          review_path(review),
                          method: :delete,
                          data: { confirm: "Are you sure?" },
                          class: "btn btn-outline-danger btn-sm",
                          form_class: "d-inline" %>

          </div>

          <!-- COLLAPSIBLE EDIT FORM -->
          <div class="collapse mt-3" id="editReview<%= review.id %>">
            <div class="card card-body bg-light">

              <%= form_with model: review,
                            url: review_path(review),
                            method: :patch,
                            local: true do |f| %>

                <div class="mb-3">
                  <%= f.label :rating, class: "form-label" %>
                  <%= f.select :rating, 1..5, {}, class: "form-select" %>
                </div>

                <div class="mb-3">
                  <%= f.label :content, class: "form-label" %>
                  <%= f.text_area :content,
                                  rows: 4,
                                  class: "form-control" %>
                </div>

                <div class="d-flex gap-2">
                  <%= f.submit "Update Review",
                               class: "btn btn-primary btn-sm" %>

                  <button type="button"
                          class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="collapse"
                          data-bs-target="#editReview<%= review.id %>">
                    Cancel
                  </button>
                </div>

              <% end %>

            </div>
          </div>

        <% end %>

      </div>
    </div>
    <div class="text-center">
      <%= link_to "See all reviews",
                  book_reviews_path(@book),
                  class: "btn btn-outline-secondary btn-sm" %>
    </div>

  <% end %>

  <% if @reviews.count > 5 %>
    <div class="text-center">
      <%= link_to "See all reviews",
                  book_reviews_path(@book),
                  class: "btn btn-outline-secondary btn-sm" %>
    </div>
  <% end %>

<% else %>

  <div class="alert alert-info">
    No reviews yet. Be the first to review this book!
  </div>

<% end %>

<% else %>

  <div class="alert alert-danger text-center">
    Book not found.
  </div>

<% end %>

</div>